/*! For license information please see background.js.LICENSE.txt */
(()=>{"use strict";var e={162:(e,t,r)=>{var n=r(540),o=r(888),a="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},s=o.useSyncExternalStore,i=n.useRef,c=n.useEffect,l=n.useMemo,u=n.useDebugValue;t.useSyncExternalStoreWithSelector=function(e,t,r,n,o){var d=i(null);if(null===d.current){var f={hasValue:!1,value:null};d.current=f}else f=d.current;d=l((function(){function e(e){if(!c){if(c=!0,s=e,e=n(e),void 0!==o&&f.hasValue){var t=f.value;if(o(t,e))return i=t}return i=e}if(t=i,a(s,e))return t;var r=n(e);return void 0!==o&&o(t,r)?(s=e,t):(s=e,i=r)}var s,i,c=!1,l=void 0===r?null:r;return[function(){return e(t())},null===l?void 0:function(){return e(l())}]}),[t,r,n,o]);var g=s(e,d[0],d[1]);return c((function(){f.hasValue=!0,f.value=g}),[g]),u(g),g}},242:(e,t,r)=>{e.exports=r(162)},287:(e,t)=>{var r=Symbol.for("react.element"),n=Symbol.for("react.portal"),o=Symbol.for("react.fragment"),a=Symbol.for("react.strict_mode"),s=Symbol.for("react.profiler"),i=Symbol.for("react.provider"),c=Symbol.for("react.context"),l=Symbol.for("react.forward_ref"),u=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),f=Symbol.for("react.lazy"),g=Symbol.iterator,p={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},m=Object.assign,h={};function y(e,t,r){this.props=e,this.context=t,this.refs=h,this.updater=r||p}function v(){}function b(e,t,r){this.props=e,this.context=t,this.refs=h,this.updater=r||p}y.prototype.isReactComponent={},y.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},y.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},v.prototype=y.prototype;var S=b.prototype=new v;S.constructor=b,m(S,y.prototype),S.isPureReactComponent=!0;var E=Array.isArray,w=Object.prototype.hasOwnProperty,T={current:null},x={key:!0,ref:!0,__self:!0,__source:!0};function I(e,t,n){var o,a={},s=null,i=null;if(null!=t)for(o in void 0!==t.ref&&(i=t.ref),void 0!==t.key&&(s=""+t.key),t)w.call(t,o)&&!x.hasOwnProperty(o)&&(a[o]=t[o]);var c=arguments.length-2;if(1===c)a.children=n;else if(1<c){for(var l=Array(c),u=0;u<c;u++)l[u]=arguments[u+2];a.children=l}if(e&&e.defaultProps)for(o in c=e.defaultProps)void 0===a[o]&&(a[o]=c[o]);return{$$typeof:r,type:e,key:s,ref:i,props:a,_owner:T.current}}function P(e){return"object"==typeof e&&null!==e&&e.$$typeof===r}var _=/\/+/g;function F(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function k(e,t,o,a,s){var i=typeof e;"undefined"!==i&&"boolean"!==i||(e=null);var c=!1;if(null===e)c=!0;else switch(i){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case r:case n:c=!0}}if(c)return s=s(c=e),e=""===a?"."+F(c,0):a,E(s)?(o="",null!=e&&(o=e.replace(_,"$&/")+"/"),k(s,t,o,"",(function(e){return e}))):null!=s&&(P(s)&&(s=function(e,t){return{$$typeof:r,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(s,o+(!s.key||c&&c.key===s.key?"":(""+s.key).replace(_,"$&/")+"/")+e)),t.push(s)),1;if(c=0,a=""===a?".":a+":",E(e))for(var l=0;l<e.length;l++){var u=a+F(i=e[l],l);c+=k(i,t,o,u,s)}else if(u=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=g&&e[g]||e["@@iterator"])?e:null}(e),"function"==typeof u)for(e=u.call(e),l=0;!(i=e.next()).done;)c+=k(i=i.value,t,o,u=a+F(i,l++),s);else if("object"===i)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return c}function A(e,t,r){if(null==e)return e;var n=[],o=0;return k(e,n,"","",(function(e){return t.call(r,e,o++)})),n}function C(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var R={current:null},O={transition:null},j={ReactCurrentDispatcher:R,ReactCurrentBatchConfig:O,ReactCurrentOwner:T};function z(){throw Error("act(...) is not supported in production builds of React.")}t.Children={map:A,forEach:function(e,t,r){A(e,(function(){t.apply(this,arguments)}),r)},count:function(e){var t=0;return A(e,(function(){t++})),t},toArray:function(e){return A(e,(function(e){return e}))||[]},only:function(e){if(!P(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},t.Component=y,t.Fragment=o,t.Profiler=s,t.PureComponent=b,t.StrictMode=a,t.Suspense=u,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=j,t.act=z,t.cloneElement=function(e,t,n){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var o=m({},e.props),a=e.key,s=e.ref,i=e._owner;if(null!=t){if(void 0!==t.ref&&(s=t.ref,i=T.current),void 0!==t.key&&(a=""+t.key),e.type&&e.type.defaultProps)var c=e.type.defaultProps;for(l in t)w.call(t,l)&&!x.hasOwnProperty(l)&&(o[l]=void 0===t[l]&&void 0!==c?c[l]:t[l])}var l=arguments.length-2;if(1===l)o.children=n;else if(1<l){c=Array(l);for(var u=0;u<l;u++)c[u]=arguments[u+2];o.children=c}return{$$typeof:r,type:e.type,key:a,ref:s,props:o,_owner:i}},t.createContext=function(e){return(e={$$typeof:c,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:i,_context:e},e.Consumer=e},t.createElement=I,t.createFactory=function(e){var t=I.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:l,render:e}},t.isValidElement=P,t.lazy=function(e){return{$$typeof:f,_payload:{_status:-1,_result:e},_init:C}},t.memo=function(e,t){return{$$typeof:d,type:e,compare:void 0===t?null:t}},t.startTransition=function(e){var t=O.transition;O.transition={};try{e()}finally{O.transition=t}},t.unstable_act=z,t.useCallback=function(e,t){return R.current.useCallback(e,t)},t.useContext=function(e){return R.current.useContext(e)},t.useDebugValue=function(){},t.useDeferredValue=function(e){return R.current.useDeferredValue(e)},t.useEffect=function(e,t){return R.current.useEffect(e,t)},t.useId=function(){return R.current.useId()},t.useImperativeHandle=function(e,t,r){return R.current.useImperativeHandle(e,t,r)},t.useInsertionEffect=function(e,t){return R.current.useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return R.current.useLayoutEffect(e,t)},t.useMemo=function(e,t){return R.current.useMemo(e,t)},t.useReducer=function(e,t,r){return R.current.useReducer(e,t,r)},t.useRef=function(e){return R.current.useRef(e)},t.useState=function(e){return R.current.useState(e)},t.useSyncExternalStore=function(e,t,r){return R.current.useSyncExternalStore(e,t,r)},t.useTransition=function(){return R.current.useTransition()},t.version="18.3.1"},493:(e,t,r)=>{var n=r(540),o="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},a=n.useState,s=n.useEffect,i=n.useLayoutEffect,c=n.useDebugValue;function l(e){var t=e.getSnapshot;e=e.value;try{var r=t();return!o(e,r)}catch(e){return!0}}var u="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?function(e,t){return t()}:function(e,t){var r=t(),n=a({inst:{value:r,getSnapshot:t}}),o=n[0].inst,u=n[1];return i((function(){o.value=r,o.getSnapshot=t,l(o)&&u({inst:o})}),[e,r,t]),s((function(){return l(o)&&u({inst:o}),e((function(){l(o)&&u({inst:o})}))}),[e]),c(r),r};t.useSyncExternalStore=void 0!==n.useSyncExternalStore?n.useSyncExternalStore:u},540:(e,t,r)=>{e.exports=r(287)},888:(e,t,r)=>{e.exports=r(493)}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var a=t[n]={exports:{}};return e[n](a,a.exports,r),a.exports}const n=e=>{let t;const r=new Set,n=(e,n)=>{const o="function"==typeof e?e(t):e;if(!Object.is(o,t)){const e=t;t=(null!=n?n:"object"!=typeof o||null===o)?o:Object.assign({},t,o),r.forEach((r=>r(t,e)))}},o=()=>t,a={setState:n,getState:o,getInitialState:()=>s,subscribe:e=>(r.add(e),()=>r.delete(e)),destroy:()=>{console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),r.clear()}},s=t=e(n,o,a);return a};var o=r(540),a=r(242);const{useDebugValue:s}=o,{useSyncExternalStoreWithSelector:i}=a;let c=!1;const l=e=>e,u=e=>{"function"!=typeof e&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const t="function"==typeof e?(e=>e?n(e):n)(e):e,r=(e,r)=>function(e,t=l,r){r&&!c&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),c=!0);const n=i(e.subscribe,e.getState,e.getServerState||e.getInitialState,t,r);return s(n),n}(t,e,r);return Object.assign(r,t),r};function d(e,t){let r;try{r=e()}catch(e){return}return{getItem:e=>{var n;const o=e=>null===e?null:JSON.parse(e,null==t?void 0:t.reviver),a=null!=(n=r.getItem(e))?n:null;return a instanceof Promise?a.then(o):o(a)},setItem:(e,n)=>r.setItem(e,JSON.stringify(n,null==t?void 0:t.replacer)),removeItem:e=>r.removeItem(e)}}const f=e=>t=>{try{const r=e(t);return r instanceof Promise?r:{then:e=>f(e)(r),catch(e){return this}}}catch(e){return{then(e){return this},catch:t=>f(t)(e)}}},g={apiKey:"",provider:"gemini",sensitivity:5,autoMode:!0,enabledPlatforms:["gmail","slack","linkedin","github","discord","teams"],formalityPreference:"semi-formal",personalStyle:"professional",blacklistedWords:[],profiles:[],notifications:{showTooltips:!0,showBadges:!0,soundEnabled:!1,frequency:"immediate"}},p={suggestionsGenerated:0,suggestionsAccepted:0,suggestionsRejected:0,platformUsage:{gmail:0,slack:0,linkedin:0,github:0,discord:0,teams:0,other:0},improvementCategories:{aggressive:0,"passive-aggressive":0,"overly-formal":0,"too-casual":0,unclear:0,"potentially-offensive":0,"micro-aggression":0,"cultural-insensitive":0,emotional:0,demanding:0,dismissive:0},averageProcessingTime:0,userSatisfactionScore:0,timesSaved:0},m=(v?u(v):u)((h=(e,t)=>({isEnabled:!0,currentAnalysis:void 0,isProcessing:!1,error:void 0,lastProcessedText:"",cache:new Map,preferences:g,analytics:p,currentPlatform:"other",showWidget:!1,widgetPosition:{x:0,y:0},updatePreferences:t=>e((e=>({preferences:{...e.preferences,...t}}))),updateAnalytics:t=>e((e=>({analytics:{...e.analytics,...t}}))),recordSuggestionFeedback:r=>{const{analytics:n}=t(),o=r.rating>=4||r.helpful;e({analytics:{...n,suggestionsAccepted:o?n.suggestionsAccepted+1:n.suggestionsAccepted,suggestionsRejected:o?n.suggestionsRejected:n.suggestionsRejected+1,userSatisfactionScore:(n.userSatisfactionScore+r.rating)/2}})},setEnabled:t=>e({isEnabled:t}),setProcessing:t=>e({isProcessing:t}),setCurrentAnalysis:r=>{if(r){const{analytics:n,currentPlatform:o}=t();e({currentAnalysis:r,analytics:{...n,suggestionsGenerated:n.suggestionsGenerated+1,platformUsage:{...n.platformUsage,[o]:n.platformUsage[o]+1},averageProcessingTime:(n.averageProcessingTime+r.processingTime)/2}})}else e({currentAnalysis:r})},setError:t=>e({error:t}),addToCache:(r,n)=>{const{cache:o}=t(),a=new Map(o);if(a.set(r.trim().toLowerCase(),n),a.size>100){const e=a.keys().next().value;e&&a.delete(e)}e({cache:a})},getFromCache:e=>{const{cache:r}=t();return r.get(e.trim().toLowerCase())},setCurrentPlatform:t=>e({currentPlatform:t}),setShowWidget:t=>e({showWidget:t}),setWidgetPosition:t=>e({widgetPosition:t})}),"getStorage"in(y={name:"tonefixer-store",partialize:e=>({preferences:e.preferences,analytics:e.analytics,isEnabled:e.isEnabled})})||"serialize"in y||"deserialize"in y?(console.warn("[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead."),((e,t)=>(r,n,o)=>{let a={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...t},s=!1;const i=new Set,c=new Set;let l;try{l=a.getStorage()}catch(e){}if(!l)return e(((...e)=>{console.warn(`[zustand persist middleware] Unable to update item '${a.name}', the given storage is currently unavailable.`),r(...e)}),n,o);const u=f(a.serialize),d=()=>{const e=a.partialize({...n()});let t;const r=u({state:e,version:a.version}).then((e=>l.setItem(a.name,e))).catch((e=>{t=e}));if(t)throw t;return r},g=o.setState;o.setState=(e,t)=>{g(e,t),d()};const p=e(((...e)=>{r(...e),d()}),n,o);let m;const h=()=>{var e;if(!l)return;s=!1,i.forEach((e=>e(n())));const t=(null==(e=a.onRehydrateStorage)?void 0:e.call(a,n()))||void 0;return f(l.getItem.bind(l))(a.name).then((e=>{if(e)return a.deserialize(e)})).then((e=>{if(e){if("number"!=typeof e.version||e.version===a.version)return e.state;if(a.migrate)return a.migrate(e.state,e.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}})).then((e=>{var t;return m=a.merge(e,null!=(t=n())?t:p),r(m,!0),d()})).then((()=>{null==t||t(m,void 0),s=!0,c.forEach((e=>e(m)))})).catch((e=>{null==t||t(void 0,e)}))};return o.persist={setOptions:e=>{a={...a,...e},e.getStorage&&(l=e.getStorage())},clearStorage:()=>{null==l||l.removeItem(a.name)},getOptions:()=>a,rehydrate:()=>h(),hasHydrated:()=>s,onHydrate:e=>(i.add(e),()=>{i.delete(e)}),onFinishHydration:e=>(c.add(e),()=>{c.delete(e)})},h(),m||p})(h,y)):((e,t)=>(r,n,o)=>{let a={storage:d((()=>localStorage)),partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...t},s=!1;const i=new Set,c=new Set;let l=a.storage;if(!l)return e(((...e)=>{console.warn(`[zustand persist middleware] Unable to update item '${a.name}', the given storage is currently unavailable.`),r(...e)}),n,o);const u=()=>{const e=a.partialize({...n()});return l.setItem(a.name,{state:e,version:a.version})},g=o.setState;o.setState=(e,t)=>{g(e,t),u()};const p=e(((...e)=>{r(...e),u()}),n,o);let m;o.getInitialState=()=>p;const h=()=>{var e,t;if(!l)return;s=!1,i.forEach((e=>{var t;return e(null!=(t=n())?t:p)}));const o=(null==(t=a.onRehydrateStorage)?void 0:t.call(a,null!=(e=n())?e:p))||void 0;return f(l.getItem.bind(l))(a.name).then((e=>{if(e){if("number"!=typeof e.version||e.version===a.version)return[!1,e.state];if(a.migrate)return[!0,a.migrate(e.state,e.version)];console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}return[!1,void 0]})).then((e=>{var t;const[o,s]=e;if(m=a.merge(s,null!=(t=n())?t:p),r(m,!0),o)return u()})).then((()=>{null==o||o(m,void 0),m=n(),s=!0,c.forEach((e=>e(m)))})).catch((e=>{null==o||o(void 0,e)}))};return o.persist={setOptions:e=>{a={...a,...e},e.storage&&(l=e.storage)},clearStorage:()=>{null==l||l.removeItem(a.name)},getOptions:()=>a,rehydrate:()=>h(),hasHydrated:()=>s,onHydrate:e=>(i.add(e),()=>{i.delete(e)}),onFinishHydration:e=>(c.add(e),()=>{c.delete(e)})},a.skipHydration||h(),m||p})(h,y)));var h,y,v;new class{constructor(){this.isInitialized=!1,this.init()}async init(){this.isInitialized||(console.log("ToneFixer: Service Worker démarré"),this.initializeStore(),this.setupListeners(),this.checkConfiguration(),this.isInitialized=!0)}initializeStore(){const e=m.getState();console.log("ToneFixer: Store initialisé",{enabled:e.isEnabled,provider:e.preferences.provider}),this.ensureDefaultPreferences()}setupListeners(){chrome.runtime.onMessage.addListener(((e,t,r)=>(this.handleMessage(e,t,r),!0))),chrome.action.onClicked.addListener((e=>{this.handleActionClick(e)})),chrome.tabs.onActivated.addListener((e=>{this.handleTabActivated(e)})),chrome.tabs.onUpdated.addListener(((e,t,r)=>{this.handleTabUpdated(e,t,r)})),chrome.runtime.onInstalled.addListener((e=>{this.handleInstalled(e)}))}async handleMessage(e,t,r){try{switch(e.type){case"GET_PREFERENCES":const t=m.getState();console.log("ToneFixer Background: Envoi des préférences:",t.preferences),r({preferences:t.preferences});break;case"UPDATE_PREFERENCES":const{updatePreferences:n}=m.getState();n(e.preferences),r({success:!0});break;case"ANALYZE_TEXT":r({analysis:await this.analyzeText(e.text,e.context)});break;case"RECORD_FEEDBACK":const{recordSuggestionFeedback:o}=m.getState();o(e.feedback),r({success:!0});break;case"GET_ANALYTICS":const{analytics:a}=m.getState();r({analytics:a});break;case"TOGGLE_EXTENSION":await this.toggleExtension(),r({success:!0});break;case"VALIDATE_API_KEY":const s=m.getState().preferences;console.log("ToneFixer: Validation de la clé API",s.provider);try{if(await this.validateApiKey(s)){console.log("ToneFixer: Clé API validée avec succès");const e=await chrome.tabs.query({});e.forEach((e=>this.updateBadgeForTab(e))),e.forEach((e=>{e.id&&chrome.tabs.sendMessage(e.id,{type:"API_KEY_UPDATED",apiKey:s.apiKey}).catch((()=>{}))})),r({success:!0,message:"Clé API valide"})}else console.warn("ToneFixer: Clé API invalide"),r({success:!1,message:"Clé API invalide"})}catch(e){console.error("ToneFixer: Erreur lors de la validation de la clé API",e),r({success:!1,message:e instanceof Error?e.message:"Erreur de validation de la clé API"})}break;case"SHOW_NOTIFICATION":try{e.title&&e.message?(chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon128.png"),title:e.title,message:e.message,priority:1}),console.log("ToneFixer: Notification affichée:",e.title),r({success:!0})):r({success:!1,message:"Informations de notification incomplètes"})}catch(e){console.error("ToneFixer: Erreur lors de l'affichage de la notification:",e),r({success:!1,error:String(e)})}break;default:r({error:"Type de message inconnu"})}}catch(e){console.error("ToneFixer: Erreur dans handleMessage:",e),r({error:e instanceof Error?e.message:"Erreur inconnue"})}}async handleActionClick(e){try{console.log("ToneFixer: Clic sur l'action pour l'onglet:",e.id)}catch(e){console.error("ToneFixer: Erreur lors du clic sur l'action:",e)}}async handleTabActivated(e){if(e&&"number"==typeof e.tabId)try{if(e.tabId<0)return void console.log("ToneFixer: ID d'onglet invalide:",e.tabId);chrome.tabs.get(e.tabId,(async e=>{chrome.runtime.lastError?console.log("ToneFixer: Onglet non disponible:",chrome.runtime.lastError.message):e&&await this.updateBadgeForTab(e)}))}catch(e){console.log("ToneFixer: Exception lors de l'activation d'onglet:",e instanceof Error?e.message:"Erreur inconnue")}else console.warn("ToneFixer: Informations d'activation d'onglet invalides")}async handleTabUpdated(e,t,r){"complete"===t.status&&r.url&&await this.updateBadgeForTab(r)}async handleInstalled(e){console.log("ToneFixer: Extension installée/mise à jour:",e.reason),this.ensureDefaultPreferences(),"install"===e.reason?await this.showWelcomePage():"update"===e.reason&&await this.handleUpdate(e.previousVersion)}ensureDefaultPreferences(){const e=m.getState();console.log("ToneFixer: Vérification des préférences par défaut"),e.preferences.enabledPlatforms&&0!==e.preferences.enabledPlatforms.length||(console.log("ToneFixer: Configuration des préférences par défaut"),e.updatePreferences({enabledPlatforms:["gmail","slack","linkedin","github","discord","teams"],autoMode:!0,sensitivity:5,provider:"gemini"}))}async analyzeText(e,t){return{score:75,level:"good",issues:[],suggestions:[],context:t,confidence:.8,processingTime:100}}async toggleExtension(){const{isEnabled:e,setEnabled:t}=m.getState(),r=!e;t(r),console.log("ToneFixer: Extension "+(r?"activée":"désactivée"));try{const e=await chrome.tabs.query({});await Promise.allSettled(e.filter((e=>e&&e.id)).map((async e=>{try{e.id&&(await new Promise((t=>{chrome.tabs.sendMessage(e.id,{type:"EXTENSION_TOGGLED",enabled:r},(()=>{chrome.runtime.lastError,t()}))})),await this.updateBadgeForTab(e))}catch(t){console.log(`ToneFixer: Impossible de notifier l'onglet ${e.id}:`,t instanceof Error?t.message:"Erreur inconnue")}})))}catch(e){console.error("ToneFixer: Erreur lors du basculement de l'extension:",e instanceof Error?e.message:"Erreur inconnue")}}async updateBadgeForTab(e){try{if(!e||!e.url||!e.id)return void console.log("ToneFixer: Onglet invalide, impossible de mettre à jour le badge");try{chrome.tabs.get(e.id,(e=>{if(chrome.runtime.lastError)console.warn("ToneFixer: Impossible de mettre à jour le badge, onglet non disponible:",chrome.runtime.lastError.message);else try{this.doUpdateBadge(e)}catch(e){console.warn("ToneFixer: Erreur lors de la mise à jour du badge:",e)}}))}catch(e){console.warn("ToneFixer: Erreur lors de l'accès à l'onglet:",e)}}catch(e){console.warn("ToneFixer: Erreur mise à jour badge:",e)}}doUpdateBadge(e){if(!e.url||!e.id)return;const t=m.getState();try{const r=new URL(e.url).hostname;if(!["mail.google.com","slack.com","app.slack.com","linkedin.com","www.linkedin.com","github.com","discord.com","teams.microsoft.com"].some((e=>r.includes(e))))return void chrome.action.setBadgeText({text:"",tabId:e.id});t.isEnabled?t.preferences.apiKey?(chrome.action.setBadgeText({text:"✓",tabId:e.id}),chrome.action.setBadgeBackgroundColor({color:"#10b981",tabId:e.id})):(chrome.action.setBadgeText({text:"⚙",tabId:e.id}),chrome.action.setBadgeBackgroundColor({color:"#f59e0b",tabId:e.id})):(chrome.action.setBadgeText({text:"⏸",tabId:e.id}),chrome.action.setBadgeBackgroundColor({color:"#9ca3af",tabId:e.id}))}catch(e){console.warn("ToneFixer: Erreur lors de la mise à jour du badge:",e)}}async checkConfiguration(){const e=m.getState();e.preferences.apiKey||console.warn("ToneFixer: Aucune clé API configurée"),e.preferences.apiKey&&await this.validateApiKey(e.preferences)}async validateApiKey(e){try{return e.apiKey&&""!==e.apiKey.trim()?"gemini"===e.provider?(console.log("ToneFixer: Validation de la clé API Gemini..."),!!(await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${e.apiKey}`)).ok||(console.warn("ToneFixer: Clé API Gemini invalide"),!1)):!("claude"!==e.provider||!e.apiKey.startsWith("sk-ant-")&&(console.warn("ToneFixer: Format de clé API Claude invalide"),1)):(console.warn("ToneFixer: Aucune clé API fournie"),!1)}catch(e){return console.error("ToneFixer: Erreur de validation API:",e),!1}}async showWelcomePage(){try{await chrome.tabs.create({url:chrome.runtime.getURL("welcome.html")})}catch(e){console.error("ToneFixer: Erreur d'ouverture de la page d'accueil:",e)}}async handleUpdate(e){console.log(`ToneFixer: Mise à jour depuis la version ${e}`),m.getState(),e&&this.compareVersions(e,"1.0.0")<0&&console.log("ToneFixer: Migration vers v1.0.0")}compareVersions(e,t){const r=e.split(".").map(Number),n=t.split(".").map(Number);for(let e=0;e<Math.max(r.length,n.length);e++){const t=r[e]||0,o=n[e]||0;if(t<o)return-1;if(t>o)return 1}return 0}async recordAnalytics(e){const{updateAnalytics:t}=m.getState();t(e)}async getUsageStats(){const{analytics:e}=m.getState();return e}}})();