(()=>{"use strict";class e{static detectPlatform(){const e=window.location.hostname,t=window.location.href,n=Date.now();if(this._cachedHostname===e&&this._cachedPlatform&&n-this._lastDetectionTime<6e4)return this._cachedPlatform;if((!this._cachedHostname||this._cachedHostname!==e||n-this._lastDetectionTime>=6e4)&&console.log("ToneFixer: Détection plateforme sur:",e),t.includes("test-page.html")||""===e||t.startsWith("file://"))return console.log("ToneFixer: Page de test locale détectée"),this._cachedHostname=e,this._cachedPlatform="gmail",this._lastDetectionTime=n,this._cachedPlatform;let i="other";return this._matchDomain(e,["mail.google.com"])?i="gmail":this._matchDomain(e,["slack.com","app.slack.com"])?i="slack":this._matchDomain(e,["linkedin.com","www.linkedin.com"])?i="linkedin":this._matchDomain(e,["github.com","www.github.com"])?i="github":this._matchDomain(e,["discord.com","www.discord.com"])?i="discord":this._matchDomain(e,["teams.microsoft.com"])?i="teams":(e.includes("google.com")||e.includes("outlook"))&&(i="gmail"),this._cachedHostname=e,this._cachedPlatform=i,this._lastDetectionTime=n,console.log(`ToneFixer: Plateforme détectée: ${i} sur ${e}`),i}static _matchDomain(e,t){return t.some((t=>e===t||e.endsWith(`.${t}`)))}static detectMessageType(e,t){return"email"}}e._cachedPlatform=null,e._cachedHostname=null,e._lastDetectionTime=0;class t{constructor(){this.isInitialized=!1,this.observedElements=new Set,this.currentTarget=null,this.analysisCache=new Map,this.preferences=null,this.isEnabled=!0,this.debugMode=!0,this._hasShownApiKeyWarning=!1,this.handleInput=function(e,t,n=!1){let i=null;return function(...s){const o=n&&!i;i&&clearTimeout(i),i=setTimeout((()=>{i=null,n||e(...s)}),t),o&&e(...s)}}((async e=>{const t=e.target,n=this.getElementText(t);!n||n.length<10||(this.currentTarget=t,await this.analyzeText(n,t))}),1e3),this.markExtensionPresence(),this.init()}markExtensionPresence(){document.documentElement.setAttribute("data-tonefixer-extension","true");try{localStorage.setItem("tonefixer-extension-loaded","true"),localStorage.setItem("tonefixer-debug",JSON.stringify({loaded:!0,timestamp:(new Date).toISOString(),url:window.location.href}))}catch(e){console.log("ToneFixer: Impossible d'écrire dans localStorage")}window.ToneFixerExtension={loaded:!0,version:"1.0.0"},console.log("ToneFixer: Extension marquée comme présente")}async init(){if(!this.isInitialized){console.log("🚀 ToneFixer Content Script: Démarrage de l'initialisation"),console.log("📍 URL:",window.location.href),console.log("🌐 Hostname:",window.location.hostname),console.log("⚙️ Debug Mode:",this.debugMode),console.log("✓ Extension Enabled:",this.isEnabled);try{await this.loadPreferences();const t=e.detectPlatform();console.log(`ToneFixer: Détection plateforme - ${t} sur ${window.location.hostname}`),console.log("ToneFixer: Préférences chargées:",this.preferences);const n=this.preferences?.enabledPlatforms||["gmail","slack","linkedin","github","discord","teams"],i=this.debugMode||n.includes(t)||"other"===t;if(!i||!this.isEnabled)return console.log("ToneFixer: Plateforme désactivée ou extension en pause"),void console.log("Debug mode:",this.debugMode,"Platform enabled:",i,"Extension enabled:",this.isEnabled);await this.injectWidget(),this.startObserving(),this.isInitialized=!0,console.log("✅ ToneFixer: Initialisé avec succès sur",t),console.log("🎯 ToneFixer: Widget injecté et observation démarrée"),window.ToneFixerExtension.initialized=!0,localStorage.setItem("tonefixer-extension-initialized","true")}catch(e){console.error("ToneFixer: Erreur d'initialisation:",e)}}}async loadPreferences(){return new Promise((e=>{try{chrome.runtime.sendMessage({type:"GET_PREFERENCES"},(t=>{if(chrome.runtime.lastError)return console.warn("ToneFixer: Erreur de communication avec le background script:",chrome.runtime.lastError.message),this.preferences={apiKey:"",provider:"gemini",sensitivity:5,autoMode:!0,enabledPlatforms:["gmail","slack","linkedin","github","discord","teams"],formalityPreference:"semi-formal",personalStyle:"professional",blacklistedWords:[],profiles:[],notifications:{showTooltips:!0,showBadges:!0,soundEnabled:!1,frequency:"immediate"}},void e();t?.preferences?(this.preferences=t.preferences,console.log("ToneFixer: Préférences reçues:",this.preferences)):(console.warn("ToneFixer: Pas de préférences reçues du background script"),this.preferences={apiKey:"",provider:"gemini",sensitivity:5,autoMode:!0,enabledPlatforms:["gmail","slack","linkedin","github","discord","teams"],formalityPreference:"semi-formal",personalStyle:"professional",blacklistedWords:[],profiles:[],notifications:{showTooltips:!0,showBadges:!0,soundEnabled:!1,frequency:"immediate"}}),e()}))}catch(t){console.error("ToneFixer: Erreur lors du chargement des préférences:",t),this.preferences={apiKey:"",provider:"gemini",sensitivity:5,autoMode:!0,enabledPlatforms:["gmail","slack","linkedin","github","discord","teams"],formalityPreference:"semi-formal",personalStyle:"professional",blacklistedWords:[],profiles:[],notifications:{showTooltips:!0,showBadges:!0,soundEnabled:!1,frequency:"immediate"}},e()}}))}async injectWidget(){return new Promise((e=>{const t=document.createElement("script");t.src=chrome.runtime.getURL("widget.js"),t.onload=()=>{e()},t.onerror=()=>{console.error("ToneFixer: Erreur de chargement du widget"),e()},(document.head||document.documentElement).appendChild(t)}))}startObserving(){new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&this.scanForTextInputs(e)}))}))})).observe(document.body,{childList:!0,subtree:!0}),this.scanForTextInputs(document.body)}scanForTextInputs(e){['input[type="text"]','input[type="email"]',"textarea",'[contenteditable="true"]','[contenteditable=""]',...this.getPlatformSpecificSelectors()].forEach((t=>{e.querySelectorAll(t).forEach((e=>{!this.observedElements.has(e)&&this.isValidTextInput(e)&&this.observeElement(e)}))}))}getPlatformSpecificSelectors(){switch(e.detectPlatform()){case"gmail":return['[role="textbox"]',".Am.Al.editable",'.editable[contenteditable="true"]','div[aria-label*="message"]'];case"slack":return['[data-qa="message_input"]',".ql-editor",'[contenteditable="true"][data-qa*="message"]'];case"linkedin":return[".ql-editor",'[data-placeholder*="message"]','[data-placeholder*="comment"]',".msg-form__contenteditable"];case"github":return[".js-comment-field",".comment-form-textarea","#new_comment_field",".js-issue-title"];case"discord":return['[data-slate-editor="true"]',".slateTextArea-1Mkdgw",'div[contenteditable="true"][role="textbox"]'];case"teams":return['[data-tid="ckeditor"]',".ts-message-compose-box",'div[contenteditable="true"][role="textbox"]'];default:return[]}}isValidTextInput(e){const t=e.getBoundingClientRect();if(0===t.width||0===t.height)return!1;if(e.hasAttribute("readonly")||e.hasAttribute("disabled"))return!1;const n=window.getComputedStyle(e);return"none"!==n.display&&"hidden"!==n.visibility&&!(e instanceof HTMLInputElement&&["search","password","number","tel","url"].includes(e.type))}observeElement(e){this.observedElements.has(e)||(this.observedElements.add(e),e.addEventListener("input",this.handleInput.bind(this)),e.addEventListener("focus",this.handleFocus.bind(this)),e.addEventListener("blur",this.handleBlur.bind(this)),this.addStatusIndicator(e),this.observedElements.size%10==0&&console.log(`ToneFixer: ${this.observedElements.size} éléments observés`))}addStatusIndicator(e){if(e.querySelector(".tonefixer-indicator"))return;const t=document.createElement("div");t.className="tonefixer-indicator",t.style.cssText="\n      position: absolute;\n      top: -2px;\n      right: -2px;\n      width: 8px;\n      height: 8px;\n      background: #3b82f6;\n      border-radius: 50%;\n      opacity: 0.7;\n      z-index: 1000;\n      pointer-events: none;\n      transition: all 0.2s ease;\n    ","static"===window.getComputedStyle(e.parentElement||e).position&&((e.parentElement||e).style.position="relative"),(e.parentElement||e).appendChild(t)}handleFocus(e){const t=e.target;this.currentTarget=t;const n=t.parentElement?.querySelector(".tonefixer-indicator");n&&(n.style.background="#10b981",n.style.opacity="1")}handleBlur(e){const t=e.target;setTimeout((()=>{this.currentTarget===t&&this.hideWidget()}),300);const n=t.parentElement?.querySelector(".tonefixer-indicator");n&&(n.style.background="#3b82f6",n.style.opacity="0.7")}getElementText(e){return e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement?e.value:"true"===e.contentEditable&&e.textContent||""}async analyzeText(t,n){const i=t.trim().toLowerCase(),s=this.analysisCache.get(i);if(s)this.showAnalysis(s,n);else{if(!this.preferences?.apiKey||""===this.preferences.apiKey.trim())return console.log("ToneFixer: Clé API manquante"),this.updateIndicator(n,"warning"),void(this._hasShownApiKeyWarning||(chrome.runtime.sendMessage({type:"SHOW_NOTIFICATION",title:"Configuration requise",message:"Veuillez configurer votre clé API dans les paramètres de ToneFixer pour activer l'analyse de ton."}),this._hasShownApiKeyWarning=!0));try{const s={platform:e.detectPlatform(),messageType:"email",relationship:"professional",formality:"semi-formal",urgency:"medium",language:"fr",threadContext:void 0,recipientContext:void 0},o=await this.sendMessage({type:"ANALYZE_TEXT",text:t,context:s});if(o?.analysis){const e=o.analysis;if(this.analysisCache.set(i,e),this.analysisCache.size>50){const e=this.analysisCache.keys().next().value;e&&this.analysisCache.delete(e)}this.showAnalysis(e,n)}}catch(e){console.error("ToneFixer: Erreur d'analyse:",e)}}}sendMessage(e){return new Promise((t=>{chrome.runtime.sendMessage(e,t)}))}showAnalysis(e,t){if(0===e.issues.length&&0===e.suggestions.length)return void this.updateIndicator(t,"good");"problematic"===e.level||"poor"===e.level?this.updateIndicator(t,"error"):"fair"===e.level?this.updateIndicator(t,"warning"):this.updateIndicator(t,"good");const n=function(e){const t=e.getBoundingClientRect();return{x:t.left+t.width/2,y:t.top}}(t);this.showWidget(n,e),"undefined"!=typeof window&&window.tonefixerRenderWidget&&window.tonefixerRenderWidget(t)}showWidget(e,t){const n=new CustomEvent("tonefixer-show-analysis",{detail:{position:e,analysis:t}});document.dispatchEvent(n)}hideWidget(){const e=new CustomEvent("tonefixer-hide-widget");document.dispatchEvent(e)}updateIndicator(e,t){const n=e.parentElement?.querySelector(".tonefixer-indicator");if(n){const e={good:"#10b981",warning:"#f59e0b",error:"#ef4444"};n.style.background=e[t],n.style.opacity="1"}}toggleExtension(){this.isEnabled=!this.isEnabled,this.isEnabled||this.hideWidget()}updatePreferences(e){this.preferences=e}}let n=null;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{n=new t})):n=new t,chrome.runtime.onMessage.addListener(((t,i,s)=>{switch(t.type){case"TOGGLE_EXTENSION":case"EXTENSION_TOGGLED":n&&n.toggleExtension(),s({success:!0});break;case"UPDATE_PREFERENCES":n&&t.preferences&&n.updatePreferences(t.preferences),s({success:!0});break;case"API_KEY_UPDATED":console.log("ToneFixer: Clé API mise à jour, rechargement des préférences"),n&&chrome.runtime.sendMessage({type:"GET_PREFERENCES"},(e=>{e?.preferences&&(n?.updatePreferences(e.preferences),console.log("ToneFixer: Préférences mises à jour avec nouvelle clé API"))})),s({success:!0});break;case"GET_PAGE_INFO":s({platform:e.detectPlatform(),url:window.location.href,title:document.title});break;default:s({error:"Unknown message type"})}return!0})),window.addEventListener("beforeunload",(()=>{}))})();